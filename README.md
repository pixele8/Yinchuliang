# 离线知识库与决策链管理系统

本项目实现了一个完全离线运行的知识库与决策链管理平台，提供类 ChatGPT 的对话式界面，并支持将多个本地知识库挂载到系统中进行后台分析。所有数据均存储在 SQLite 数据库中，可在无网络环境下完成知识问答、决策链记录、评论反馈和用户管理，并可一键打包为 Windows EXE 安装包分发。

## 功能特性

- **对话式桌面界面**：全新玻璃拟态设计的 PySide6 聊天窗口，左侧知识库管理、右侧实时问答，具备渐变背景与柔和阴影的消息气泡体验。
- **多知识库挂载**：可将任意文件夹作为知识库挂载，系统自动解析其中的文本文件，切分成知识片段并建立检索索引。
- **批量文件解析**：支持 TXT/Markdown/JSON/CSV 等文本格式，自动识别编码，重复导入会进行增量更新。
- **工艺问答与匹配评分**：内置 TF-IDF 相似度检索，按照匹配度排序返回最相关的工艺处理方案。
- **决策链沉淀**：记录处理流程、背景与结果，可搜索、评论、评分，形成完整的知识闭环。
- **用户与后台管理**：提供本地账户体系、管理员审计日志、系统统计视图，适用于多用户协作环境。
- **数据导入导出**：一键导出/导入 JSON 数据，方便在离线环境之间迁移或备份知识库。
- **完全离线部署**：无需外部服务即可运行，并提供 PyInstaller 打包脚本生成独立 EXE 安装包。

## 安装与运行

1. **准备环境**

   ```bash
   git clone <repo-url>
   cd Yinchuliang
   python -m venv .venv
   source .venv/bin/activate  # Windows 请执行 .venv\Scripts\activate
   pip install -e .
   ```

   安装过程会自动拉取 `PySide6` 等 GUI 依赖。

2. **启动图形界面**

   ```bash
   python main.py
   ```

   首次运行会在 `~/OfflineKnowledge/knowledge.db`（Windows 下位于用户目录）创建数据库。

3. **挂载知识库**

   - 在左侧点击「挂载知识库」，选择一个包含工艺知识文档的文件夹。
   - 输入知识库名称后系统会在后台解析文件，切分为知识片段并写入数据库。
   - 导入完成后即可在聊天窗口中提问，系统将返回最相关的片段摘要。

### 图形界面交互说明

- 左侧列表：展示所有已挂载的知识库，可快速切换。
- 状态栏：提示当前加载状态，例如导入进度、检索中等。
- 聊天区域：用户与助手的消息以卡片式气泡展示，匹配结果附带相似度并呈现柔和渐变色块。
- 输入框：支持多行编辑，点击「发送」或按下快捷键即可提交问题。

## 命令行工具（可选）

除图形界面外，系统仍然保留功能完整的命令行工具，适用于批处理或运维脚本。执行方式如下：

```bash
python -m kb_app.cli --database my.db add-knowledge "退火工序" "退火炉温度异常如何处理？" "检查温度传感器并重新校准" --tags "退火,温度"
python -m kb_app.cli --database my.db ask "退火炉温度异常" --corpus-id 1
```

运行 `python -m kb_app.cli --help` 可查看所有子命令。知识条目、问答等命令均新增了 `--corpus-id` 参数，可将操作限定在某个知识库中。

## 知识库挂载与文件支持

- 支持的文本格式：`.txt`、`.md`、`.rst`、`.json`、`.yaml/.yml`、`.ini/.cfg`、`.csv/.tsv`、`.log`。
- 每个文件会自动拆分为约 800 个字符的知识片段，并保留 80 字符的重叠，保证上下文连贯。
- 系统记录文件哈希，重复导入会自动替换已存在的片段，实现增量更新。
- 可通过左侧列表管理多个知识库，聊天窗口始终针对当前选中的知识库进行检索。

## 打包为 Windows EXE 安装包

项目提供了 `offline_kb.spec`，可直接使用 PyInstaller 生成完整的图形化安装包：

```bash
pip install pyinstaller
pyinstaller offline_kb.spec
```

构建完成后，在 `dist/OfflineKnowledgeApp/` 目录下会生成可执行文件和依赖。将整个文件夹压缩后即可分发，目标机器无需 Python 环境即可离线运行。若需要单文件模式，可在命令中附加 `--onefile`，但首次启动会解压缓存，建议为更快的启动体验保留默认设置。

## 数据结构

数据库默认位于 `~/OfflineKnowledge/knowledge.db`，主要表结构如下：

- `knowledge`：知识片段（标题、问题、答案、标签、所属知识库、创建时间）。
- `knowledge_corpora`：知识库元数据（名称、路径、描述、创建时间）。
- `corpus_files`：挂载文件记录（文件名、路径、哈希、所属知识库）。
- `knowledge_chunks`：文件与知识条目之间的映射关系。
- `decision_history`：决策链记录（背景、步骤、结果、标签、创建时间）。
- `history_comments`：决策链评论及评分。
- `users`、`admin_events`：用户体系和后台审计日志。

## 开发与测试

开发阶段可执行以下命令进行静态检查，确保源码能够正常编译：

```bash
python -m compileall kb_app main.py
```

## 许可协议

本项目以 MIT License 发布，可在遵守协议的前提下自由使用与二次开发。
