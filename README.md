# 离线知识库与决策链管理系统

本项目实现了一个完全离线运行的知识库与决策链管理平台，提供类 ChatGPT 的对话式界面，并支持将多个本地知识库挂载到系统中进行后台分析。所有数据均存储在 SQLite 数据库中，可在无网络环境下完成知识问答、决策链记录、评论反馈和用户管理，并可一键打包为 Windows EXE 安装包分发。

## 功能特性

- **对话式桌面界面**：全新玻璃拟态的无边框 PySide6 窗口，支持拖拽移动、动感渐变背景、霓虹菜单与柔和阴影的消息气泡，呈现蓝色主题的类 ChatGPT 高级聊天体验。
- **霓虹导航与动效**：顶部胶囊式导航栏覆盖概览、问答、决策档案与知识库管理，配合淡入转场、按钮辉光与状态脉冲动画，突出关键操作入口。
- **多知识库挂载**：可将任意文件夹作为知识库挂载，系统自动解析其中的文本文件，切分成知识片段并建立检索索引。
- **批量文件解析**：支持 TXT/Markdown/JSON/CSV 等文本格式，自动识别编码，重复导入会进行增量更新。
- **工艺问答与匹配评分**：内置 TF-IDF 相似度检索，按照匹配度排序返回最相关的工艺处理方案。
- **决策链沉淀**：记录处理流程、背景与结果，可搜索、评论、评分，形成完整的知识闭环。
- **账号登录与后台管理**：提供本地注册、登录、登出与管理员审计日志，界面内置用户菜单，可快速切换账号或退出。
- **决策链检索中心**：顶栏集成决策链搜索弹窗，可离线检索历史处理流程并查看评论评分。
- **内置示例知识库**：首次运行自动下发示例知识库与演示账号，帮助工程师快速体验多文件知识挂载与决策链搜索流程。
- **数据导入导出**：一键导出/导入 JSON 数据，方便在离线环境之间迁移或备份知识库。
- **完全离线部署**：无需外部服务即可运行，并提供 PyInstaller 打包脚本生成独立 EXE 安装包。
- **标准化知识蓝图**：提供可复用的 Markdown 模板及自动解析逻辑，工程师只需填写蓝图即可批量生成结构化知识条目。

## 安装与运行

1. **准备环境**

   ```bash
   git clone <repo-url>
   cd Yinchuliang
   python -m venv .venv
   source .venv/bin/activate  # Windows 请执行 .venv\Scripts\activate
   pip install -e .
   ```

   安装过程会自动拉取 `PySide6` 等 GUI 依赖。

2. **启动图形界面**

   ```bash
   python main.py
   ```

   首次运行会在 `~/OfflineKnowledge/knowledge.db`（Windows 下位于用户目录）创建数据库。

   系统会自动创建示例管理员账号 `admin` / `Admin@123`，并在 `~/OfflineKnowledge/demo_corpus/` 下载一套多文件的「示例知识库」。登录后即可直接体验聊天问答、知识库切换与决策链检索，也可在界面中注册新的本地用户。

3. **挂载知识库**

   - 在左侧点击「挂载知识库」，选择一个包含工艺知识文档的文件夹。
   - 输入知识库名称后系统会在后台解析文件，切分为知识片段并写入数据库。
   - 导入完成后即可在聊天窗口中提问，系统将返回最相关的片段摘要。
   - 如需移除示例或旧版本资料，可选中列表中的知识库并点击「删除知识库」，系统会连同关联片段一并清理。

### 图形界面交互说明

- 顶部操作条：提供用户菜单（退出登录/切换账号）与「决策链检索」入口，可随时搜索历史处理流程。
- 左侧列表：展示所有已挂载的知识库，可快速切换，并支持一键删除当前选中知识库。
- 状态栏：提示当前加载状态，例如导入进度、检索中等，并显示当前登录用户及知识库信息。
- 聊天区域：用户与助手的消息以卡片式气泡展示，匹配结果附带相似度并呈现柔和渐变色块。
- 输入框：支持多行编辑，点击「发送」或按下快捷键即可提交问题。

### 预置体验数据

- **示例账号**：`admin` / `Admin@123`，拥有管理员权限，可立即管理知识库或创建新用户。
- **示例知识库**：`示例知识库` 自动挂载至左侧列表，源文件位于 `~/OfflineKnowledge/demo_corpus/`，包含 Markdown 与 JSON 混合示例，可直接删除或更新为自有资料。
- **示例决策链**：内置两条典型处理流程及评论，方便通过顶栏「决策链检索」快速演示搜索体验。

## 命令行工具（可选）

除图形界面外，系统仍然保留功能完整的命令行工具，适用于批处理或运维脚本。执行方式如下：

```bash
python -m kb_app.cli --database my.db add-knowledge "退火工序" "退火炉温度异常如何处理？" "检查温度传感器并重新校准" --tags "退火,温度"
python -m kb_app.cli --database my.db ask "退火炉温度异常" --corpus-id 1
```

运行 `python -m kb_app.cli --help` 可查看所有子命令。知识条目、问答等命令均新增了 `--corpus-id` 参数，可将操作限定在某个知识库中。

### 导出知识蓝图模板

若希望以标准化文档方式整理工艺知识，可执行以下命令导出蓝图模板：

```bash
python -m kb_app.cli blueprint-template 工艺蓝图示例.md
```

模板同时保存在仓库的 [`docs/knowledge_blueprint_template.md`](docs/knowledge_blueprint_template.md) 中，便于协作共享。只需替换 JSON 元信息与各章节内容即可。

## 知识库挂载与文件支持

- 支持的文本格式：`.txt`、`.md`、`.rst`、`.json`、`.yaml/.yml`、`.ini/.cfg`、`.csv/.tsv`、`.log`。
- 每个文件会自动拆分为约 800 个字符的知识片段，并保留 80 字符的重叠，保证上下文连贯。
- 系统记录文件哈希，重复导入会自动替换已存在的片段，实现增量更新。
- 可通过左侧列表管理多个知识库，聊天窗口始终针对当前选中的知识库进行检索。
- 对于包含 `type: "knowledge_blueprint"` 元信息代码块的 Markdown 文档，系统会解析出工艺概览、操作步骤、关键参数、常见问题等结构化条目，并自动附上蓝图标签，便于精准检索。

## 打包为 Windows EXE 安装包

项目提供了 `offline_kb.spec`，可直接使用 PyInstaller 生成完整的图形化安装包：

```bash
pip install pyinstaller
pyinstaller offline_kb.spec
```

构建完成后，在 `dist/OfflineKnowledgeApp/` 目录下会生成可执行文件和依赖。将整个文件夹压缩后即可分发，目标机器无需 Python 环境即可离线运行。若需要单文件模式，可在命令中附加 `--onefile`，但首次启动会解压缓存，建议为更快的启动体验保留默认设置。

## 数据结构

数据库默认位于 `~/OfflineKnowledge/knowledge.db`，主要表结构如下：

- `knowledge`：知识片段（标题、问题、答案、标签、所属知识库、创建时间）。
- `knowledge_corpora`：知识库元数据（名称、路径、描述、创建时间）。
- `corpus_files`：挂载文件记录（文件名、路径、哈希、所属知识库）。
- `knowledge_chunks`：文件与知识条目之间的映射关系。
- `decision_history`：决策链记录（背景、步骤、结果、标签、创建时间）。
- `history_comments`：决策链评论及评分。
- `users`、`admin_events`：用户体系和后台审计日志。

## 开发与测试

开发阶段可执行以下命令进行静态检查，确保源码能够正常编译：

```bash
python -m compileall kb_app main.py
```

## 如何在 GitHub 上更新项目

1. **同步最新代码**：

   ```bash
   git pull origin <你的分支>
   ```

2. **确认改动**：在本地完成开发后，查看差异确保内容准确。

   ```bash
   git status
   git diff
   ```

3. **提交到本地仓库**：为本次改动撰写简洁明了的提交信息。

   ```bash
   git add .
   git commit -m "feat: 描述你的改动"
   ```

4. **推送到 GitHub**：将本地分支更新推送到远程仓库。

   ```bash
   git push origin <你的分支>
   ```

5. **创建 Pull Request（如需合并主分支）**：在 GitHub 页面选择相应分支发起 PR，填写改动摘要与测试情况，等待审核合并。

### 处理主分支变更与冲突

当远程 `main` 分支有新的提交时，推荐在个人功能分支上执行以下流程以保持同步并解决潜在冲突：

1. **获取远程更新并切换到功能分支**：

   ```bash
   git fetch origin
   git checkout <你的分支>
   ```

2. **合并或变基远程主分支**：

   ```bash
   git merge origin/main
   # 或者
   git rebase origin/main
   ```

   - `merge` 会生成一次新的合并提交，保留完整历史；
   - `rebase` 会重写当前分支历史，使其基于最新 `main`，历史更线性。

3. **解决冲突**：若命令行提示存在冲突，可打开 Git 工具（如 VS Code、Sourcetree）或手动编辑冲突文件：

   - 查找包含 `<<<<<<<`、`=======`、`>>>>>>>` 标记的区域；
   - 保留正确的代码内容并删除冲突标记；
   - 完成所有冲突文件的调整后执行 `git add <文件>`。

4. **完成合并/变基并验证**：

   ```bash
   git status          # 确认所有冲突均已解决
   git commit          # merge 时需要提交一次合并记录
   # 若使用 rebase：
   git rebase --continue
   ```

   解决冲突后再次运行项目测试或编译命令，确保最新代码能够正常工作。

5. **推送更新后的分支**：

   ```bash
   git push origin <你的分支>
   # 若使用 rebase 且出现推送被拒绝，可改用：
   git push origin <你的分支> --force-with-lease
   ```

   推送成功后，在 Pull Request 中确认展示的是最新的合并结果。

## 许可协议

本项目以 MIT License 发布，可在遵守协议的前提下自由使用与二次开发。
